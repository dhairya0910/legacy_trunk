<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Feed</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
.carousel-item {
  transition: opacity 0.3s ease-in-out;
}
.story-ring {
  background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
}
.story-viewed {
  background: #9ca3af;
}
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-2xl mx-auto py-8 px-4">

  <!-- STORIES SECTION -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex space-x-4 overflow-x-auto pb-2">
      <!-- ADD STORY CARD -->
      <div class="flex-shrink-0 w-20 text-center">
        <label for="storyInput" class="cursor-pointer">
          <div class="w-16 h-16 mx-auto bg-gray-200 rounded-full flex items-center justify-center mb-1 border-2 border-dashed border-gray-400 hover:border-gray-600">
            <span class="material-icons text-gray-600">add</span>
          </div>
          <span class="text-xs text-gray-600">Add Story</span>
        </label>
        <form id="storyForm" action="/add-story" method="POST" enctype="multipart/form-data" class="hidden">
          <input type="file" id="storyInput" name="storyFile" accept="image/*,video/*" required>
        </form>
      </div>

      <!-- USER STORIES -->
      <% if (stories && stories.length > 0) { %>
        <% stories.forEach(story => { %>
          <a href="/story/<%= story._id %>" class="flex-shrink-0 w-20 text-center no-underline">
            <div class="w-16 h-16 mx-auto story-ring rounded-full p-0.5 mb-1 <%= story.views && story.views.length > 0 ? 'story-viewed' : '' %>">
              <div class="w-full h-full bg-white rounded-full p-0.5">
                <div class="w-full h-full bg-gray-300 rounded-full overflow-hidden">
                  <% if(story.mediaType === 'video'){ %>
                    <video class="w-full h-full object-cover">
                      <source src="<%= story.media %>">
                    </video>
                  <% } else { %>
                    <img src="<%= story.media %>" class="w-full h-full object-cover" alt="Story">
                  <% } %>
                </div>
              </div>
            </div>
            <span class="text-xs text-gray-600">Your Story</span>
          </a>
        <% }) %>
      <% } %>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <form action="/search" method="GET" class="mb-6 flex">
    <input type="text" name="q" placeholder="Search posts or tags..." 
      class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-r-lg">Search</button>
  </form>

  <!-- CREATE POST -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <form id="postForm" action="/add-media" method="POST" enctype="multipart/form-data">
      <textarea name="item" placeholder="What's on your mind?" 
        class="w-full border border-gray-300 rounded-lg p-4 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>

      <!-- TAGS -->
      <label class="block mt-4 font-medium text-gray-700">Select Tags</label>
      <div class="flex flex-wrap gap-2 mt-2">
        <% if (tags && tags.length > 0) { %>
          <% tags.forEach(tag => { %>
            <label class="flex items-center space-x-1 text-sm px-3 py-1 bg-gray-100 rounded-full cursor-pointer">
              <input type="checkbox" name="tags" value="<%= tag.name %>">
              <span>#<%= tag.name %></span>
            </label>
          <% }) %>
        <% } %>
      </div>

      <label class="block mt-3 font-medium text-gray-700">Or Add New Tags (space separated)</label>
      <input type="text" name="tags_input" placeholder="#birthday #trip" 
        class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">

      <!-- MULTIPLE MEDIA UPLOAD -->
      <div class="mt-4">
        <label class="flex items-center space-x-2 text-gray-600 cursor-pointer hover:text-blue-600">
          <span class="material-icons text-3xl font-bold">add</span>
          <span>Add Media</span>
          <input type="file" name="files" id="mediaInput" class="hidden" accept="image/*,video/*" multiple>
        </label>
        
        <!-- MEDIA PREVIEW CONTAINER -->
        <div id="mediaPreview" class="mt-4 grid grid-cols-3 gap-2"></div>
      </div>

      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium mt-4">Post</button>
    </form>
  </div>

  <!-- DOWNLOAD PDF BUTTON -->
<div class="mb-4 text-right">
  <a href="/download-pdf" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
    Download PDF
  </a>
</div>


  <!-- POSTS FEED -->
  <div class="space-y-6">
    <% if (items && items.length > 0) { %>
      <% items.forEach(item => { %>
      <div class="bg-white rounded-lg shadow p-6">

        <!-- POST HEADER -->
        <div class="flex justify-between items-start mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
              <span class="material-icons text-white">person</span>
            </div>
            <div>
              <h3 class="font-semibold">You</h3>
              <p class="text-gray-500 text-sm"><%= new Date(item.createdAt).toLocaleDateString() %></p>
            </div>
          </div>

          <!-- THREE DOTS MENU -->
          <div class="relative">
            <button class="three-dots-btn text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100">
              <span class="material-icons">more_vert</span>
            </button>
            <div class="three-dots-menu absolute right-0 top-10 bg-white shadow-lg rounded-lg py-2 z-10 hidden w-32">
              <button class="edit-post-btn w-full text-left px-4 py-2 hover:bg-gray-100 text-blue-600" 
                      data-id="<%= item._id %>" data-text="<%= item.text || '' %>">Edit Post</button>
              <form action="/delete/<%= item._id %>" method="POST" class="w-full">
                <button type="submit" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">Delete Post</button>
              </form>
            </div>
          </div>
        </div>

        <!-- POST CONTENT -->
        <% if (item.text) { %>
        <p class="text-gray-800 mb-2 whitespace-pre-wrap"><%= item.text %></p>
        <% } %>

        <!-- TAGS -->
        <% if (item.tags && item.tags.length > 0) { %>
          <div class="mb-2 flex flex-wrap gap-2">
            <% item.tags.forEach(tag => { %>
              <span class="text-xs bg-gray-200 px-2 py-1 rounded-full">#<%= tag %></span>
            <% }) %>
          </div>
        <% } %>

        <!-- MEDIA CAROUSEL -->
        <% if(item.media && item.media.length > 0) { %>
          <div class="mb-4 rounded-lg overflow-hidden border relative">
            <div class="carousel relative w-full h-96 bg-black">
              <% item.media.forEach((media, index) => { %>
                <div class="carousel-item absolute inset-0 w-full h-full <%= index === 0 ? 'opacity-100' : 'opacity-0' %> transition-opacity duration-300" data-index="<%= index %>">
                  <% if(media.type === 'video'){ %>
                    <video controls class="w-full h-full object-contain">
                      <source src="<%= media.url %>" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                  <% } else { %>
                    <img src="<%= media.url %>" class="w-full h-full object-contain" alt="Post image" onerror="console.error('Failed to load image:', this.src)">
                  <% } %>
                </div>
              <% }) %>
              
              <!-- NAVIGATION ARROWS -->
              <% if(item.media.length > 1) { %>
                <button class="carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 z-10">
                  <span class="material-icons">chevron_left</span>
                </button>
                <button class="carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 z-10">
                  <span class="material-icons">chevron_right</span>
                </button>
                
                <!-- CAROUSEL INDICATORS -->
                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
                  <% item.media.forEach((_, index) => { %>
                    <button class="carousel-indicator w-2 h-2 rounded-full bg-white bg-opacity-50 <%= index === 0 ? 'bg-opacity-100' : '' %>" data-index="<%= index %>"></button>
                  <% }) %>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>

        <!-- ENGAGEMENT BUTTONS -->
        <div class="flex items-center mb-4 space-x-6 border-t border-b py-3">
          <button type="button" class="like-btn flex items-center space-x-1 text-gray-600 hover:text-blue-600 transition-colors" data-id="<%= item._id %>">
            <span class="material-icons">thumb_up</span>
            <span class="like-count text-sm font-medium"><%= item.likes || 0 %></span>
          </button>
          
          <button type="button" class="flex items-center space-x-1 text-gray-600 hover:text-green-600">
            <span class="material-icons">chat_bubble_outline</span>
            <span class="text-sm font-medium"><%= item.comments ? item.comments.length : 0 %></span>
          </button>
          
          <button type="button" class="share-btn flex items-center space-x-1 text-gray-600 hover:text-purple-600" data-id="<%= item._id %>">
            <span class="material-icons">share</span>
            <span class="share-count text-sm font-medium"><%= item.shares || 0 %></span>
          </button>
        </div>

        <!-- COMMENTS -->
        <div class="mt-4">
          <% if(item.comments && item.comments.length > 0){ %>
            <div class="space-y-2 mb-4">
              <% item.comments.forEach(comment => { %>
              <div class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="material-icons text-white text-sm">person</span>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <span class="font-medium text-sm">You</span>
                      <p class="text-gray-700 text-sm mt-1"><%= comment.text %></p>
                    </div>
                    <form action="/delete-comment/<%= item._id %>/<%= comment._id %>" method="POST">
                      <button type="submit" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
              <% }) %>
            </div>
          <% } %>

          <!-- ADD COMMENT -->
          <form action="/comment/<%= item._id %>" method="POST" class="flex space-x-2">
            <input type="text" name="commentText" placeholder="Write a comment..." 
              class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full">
              <span class="material-icons text-sm">send</span>
            </button>
          </form>
        </div>

        <!-- EDIT FORM -->
        <div id="edit-form-<%= item._id %>" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
          <form action="/edit/<%= item._id %>" method="POST" class="space-y-3">
            <textarea name="newText" class="w-full border border-gray-300 rounded-lg p-3 resize-none focus:ring-2 focus:ring-blue-500" rows="3"><%= item.text || '' %></textarea>
            <div class="flex space-x-2">
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Save</button>
              <button type="button" class="cancel-edit bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg" data-id="<%= item._id %>">Cancel</button>
            </div>
          </form>
        </div>

      </div>
      <% }) %>
    <% } else { %>
      <div class="bg-white rounded-lg shadow p-6 text-center">
        <p class="text-gray-500">No posts yet. Create your first post!</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Load client JS (moved from inline) -->
<script src="/js/feed.js"></script>

</body>
</html>
